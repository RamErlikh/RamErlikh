import re
import sys

def modify_html_file(input_file, output_file):
    try:
        with open(input_file, "r", encoding="utf-8") as f:
            content = f.read()
    except FileNotFoundError:
        print(f"Error: File '{input_file}' not found.")
        sys.exit(1)
    
    # --- Cosmic Space Scrolling Fix ---
    cosmic_scroll_css = """
<!-- Cosmic Space Scrolling Fix -->
<style id="cosmic-space-scroll-fix">
  body.theme-space {
    overflow-y: auto !important;
    height: auto !important;
  }
</style>
"""
    
    # --- Music Player Fix with Skip Button ---
    # This block waits until window load (with a 1-second delay to let other scripts settle).
    # It removes any existing <audio> elements, defines an array of 5 SoundHelix tracks,
    # creates a new hidden audio element (id "myAudio") loaded with the first track,
    # and binds event listeners to update the toggle button (id "audio-toggle").
    # The click handler on the toggle button toggles play/pause without resetting the current time.
    # Additionally, it locates the skip button (id "audio-next") and binds a click event to advance
    # to the next track immediately.
    music_player_js = """
<!-- Music Player Fix -->
<script id="music-player-fix">
if (!window.__musicPlayerInjected) {
  window.__musicPlayerInjected = true;
  window.addEventListener('load', function(){
    setTimeout(function(){
      // Remove any existing audio elements.
      document.querySelectorAll('audio').forEach(function(a){
        a.pause();
        a.remove();
      });
      
      // Define the 5 SoundHelix tracks.
      var tracks = [
        { title: 'SoundHelix Song 1', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
        { title: 'SoundHelix Song 2', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3' },
        { title: 'SoundHelix Song 3', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
        { title: 'SoundHelix Song 4', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3' },
        { title: 'SoundHelix Song 5', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' }
      ];
      var currentTrackIndex = 0;
      
      // Create a new hidden audio element.
      var audio = document.createElement('audio');
      audio.id = "myAudio";
      audio.src = tracks[currentTrackIndex].url;
      audio.preload = "auto";
      audio.style.display = "none";
      document.body.appendChild(audio);
      
      // Function to update the toggle button icon.
      function updateToggleIcon() {
        var btn = document.getElementById("audio-toggle");
        if (btn) {
          btn.innerHTML = audio.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
        }
      }
      audio.addEventListener("play", updateToggleIcon);
      audio.addEventListener("pause", updateToggleIcon);
      
      // When a track ends, auto-cycle to the next track.
      audio.addEventListener("ended", function(){
        currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
        audio.src = tracks[currentTrackIndex].url;
        audio.load();
        audio.play().catch(function(err){
          console.error("Error playing next track:", err);
        });
      });
      
      // Bind the toggle button.
      var toggleButton = document.getElementById("audio-toggle");
      if (!toggleButton) {
        console.error("Audio toggle button with id 'audio-toggle' not found.");
        return;
      }
      // Clone to remove any pre-bound listeners.
      var newToggle = toggleButton.cloneNode(true);
      toggleButton.parentNode.replaceChild(newToggle, toggleButton);
      toggleButton = newToggle;
      
      // Toggle play/pause without resetting the current time.
      toggleButton.addEventListener("click", function(e){
        e.preventDefault();
        if (audio.paused) {
          audio.play().catch(function(err){ console.error("Error playing audio:", err); });
        } else {
          audio.pause();
        }
      }, true);
      
      // Bind the skip button.
      var skipButton = document.getElementById("audio-next");
      if (skipButton) {
        var newSkip = skipButton.cloneNode(true);
        skipButton.parentNode.replaceChild(newSkip, skipButton);
        skipButton = newSkip;
        skipButton.addEventListener("click", function(e){
          e.preventDefault();
          // Advance to next track.
          currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
          audio.src = tracks[currentTrackIndex].url;
          audio.load();
          audio.play().catch(function(err){
            console.error("Error playing next track:", err);
          });
        }, true);
      } else {
        console.warn("Skip button with id 'audio-next' not found.");
      }
      
      console.log("Music player fix injected.");
    }, 1000);
  });
}
</script>
"""
    
    # Inject CSS fix before </head>
    modified_content, count = re.subn(r'</head>', cosmic_scroll_css + "\n</head>", content, flags=re.IGNORECASE)
    if count == 0:
        print("Warning: '</head>' tag not found for CSS injection.")
    
    # Inject JS fix before </body>
    modified_content, count2 = re.subn(r'</body>', music_player_js + "\n</body>", modified_content, flags=re.IGNORECASE)
    if count2 == 0:
        print("Error: '</body>' tag not found for JS injection.")
        sys.exit(1)
    
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(modified_content)
    print("File modified successfully and saved as", output_file);

if __name__ == "__main__":
    input_filename = "portfolio.html"
    output_filename = "portfolio_modified.html"
    modify_html_file(input_filename, output_filename)
